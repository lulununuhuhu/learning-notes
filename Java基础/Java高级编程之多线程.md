[TOC]

## ç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹

1. ç¨‹åºï¼šä¸ºå®Œæˆç‰¹å®šä»»åŠ¡ã€ç”¨æŸç§è¯­è¨€ç¼–å†™çš„ä¸€ç»„æŒ‡ä»¤çš„é›†åˆï¼Œå³æŒ‡ä¸€æ®µé™æ€çš„ä»£ç ã€‚

2. è¿›ç¨‹ï¼šæ˜¯ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œæˆ–æ˜¯æ­£åœ¨è¿è¡Œçš„ä¸€ä¸ªç¨‹åºã€‚**æ˜¯ä¸€ä¸ªåŠ¨æ€çš„è¿‡ç¨‹**ï¼šæœ‰å®ƒè‡ªèº«çš„äº§ç”Ÿã€å­˜åœ¨å’Œæ¶ˆäº¡çš„è¿‡ç¨‹ã€‚

   - ç¨‹åºæ˜¯é™æ€çš„ï¼Œè¿›ç¨‹æ˜¯åŠ¨æ€çš„
   - è¿›ç¨‹ä½œä¸º**æ“ä½œç³»ç»Ÿèµ„æºè°ƒåº¦åˆ†é…çš„æœ€å°å•ä½**ï¼Œç³»ç»Ÿåœ¨è¿è¡Œæ—¶ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸åŒçš„å†…å­˜åŒºåŸŸ

3. çº¿ç¨‹ï¼šè¿›ç¨‹å¯è¿›ä¸€æ­¥ç»†åŒ–ä¸ºçº¿ç¨‹ï¼Œæ˜¯ä¸€ä¸ªç¨‹åºå†…éƒ¨çš„ä¸€æ¡æ‰§è¡Œè·¯å¾„ã€‚

   - è‹¥ä¸€ä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´å¯**å¹¶è¡Œ**å¤šä¸ªçº¿ç¨‹ï¼Œé‚£å°±æ˜¯æ”¯æŒå¤šçº¿ç¨‹çš„ã€‚ï¼ˆæ¯”å¦‚åœ¨QQç”µè„‘ç®¡å®¶ä¸­ï¼Œç—…æ¯’æ‰«ææ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œåƒåœ¾æ¸…ç†æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¿è¡Œï¼‰
   
   - **çº¿ç¨‹ä½œä¸ºCPUè°ƒåº¦å’Œæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„è¿è¡Œæ ˆå’Œç¨‹åºè®¡æ•°å™¨**ã€‚çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€å°ã€‚ï¼ˆä¸€ä¸ªJAVAåº”ç”¨ç¨‹åºjava.exeï¼Œè‡³å°‘æœ‰ä¸‰ä¸ªçº¿ç¨‹ï¼šmain()ä¸»çº¿ç¨‹,åƒåœ¾å›æ”¶çº¿ç¨‹ï¼Œå¼‚å¸¸ï¼‰

   - ä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å…±äº«ç›¸åŒçš„å†…å­˜å•å…ƒ/å†…å­˜åœ°å€ç©ºé—´--->ä»–ä»¬ä»åŒä¸€å †ä¸­åˆ†é…å¯¹è±¡ï¼Œå¯ä»¥**å…±äº«å †å’Œæ–¹æ³•åŒºçš„å˜é‡å’Œå¯¹è±¡**ï¼Œ**ä½†ä¸åŒçº¿ç¨‹çš„æ ˆæ˜¯ç‹¬ç«‹çš„**ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªæ ˆã€‚ä»è€Œä½¿å¾—çº¿ç¨‹é—´é€šä¿¡æ›´ç®€ä¾¿ã€é«˜æ•ˆã€‚å¤šçº¿ç¨‹å¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼Œä½†ç”±äºå¤šä¸ªçº¿ç¨‹æ“ä½œå…±äº«çš„ç³»ç»Ÿèµ„æºï¼Œå¦‚æœä½¿ç”¨ä¸å½“ï¼Œä¼šå¸¦æ¥å®‰å…¨éšæ‚£(å¤šçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„æ“ä½œå¯¼è‡´çš„å®‰å…¨é—®é¢˜)ã€‚
   
     ![image-20230318152013560](img/image-20230318152013560.png)
   
   â€‹												JVMå†…å­˜åŒºåŸŸ
   
4. å•æ ¸CPUå’Œå¤šæ ¸CPU

   å•æ ¸CPUå°±æ˜¯ä¸€ä¸ªCPUå¤„ç†è¿›ç¨‹ã€‚CPUä»¥ä¸€ä¸ªæ—¶é—´å•ä½ä¸ºåŸºå‡†ï¼Œç„¶åæŒ‰ç…§æ—¶é—´ç‰‡è°ƒåº¦ä¸ºç®—æ³•ï¼Œåœ¨ä¸åŒçš„æ—¶é—´ç‰‡ä¸Šå¤„ç†ä¸åŒçš„è¿›ç¨‹ä»»åŠ¡ã€‚ç”±äºæ—¶é—´å•ä½æ—¶é—´å¾ˆçŸ­ï¼Œæ‰€ä»¥äººä»¬åœ¨ä½¿ç”¨ä¸Šæ„Ÿè§‰ä¸å‡ºæ¥æ˜¯å¼‚æ­¥çš„ï¼Œè®¤ä¸ºæ˜¯åŒæ—¶çš„ã€‚

   å¤šæ ¸CPUçš„è¯å°±æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥åœ¨ä¸åŒçš„CPUä¸Šè¿è¡Œï¼Œå°±æ›´å¥½çš„å‘æŒ¥äº†å¤šçº¿ç¨‹çš„æ•ˆç‡ã€‚
   
## å¤šçº¿ç¨‹çš„åˆ›å»º

   æ–¹å¼ä¸€ï¼š

   1. åˆ›å»ºäºä¸€ä¸ªç»§æ‰¿äºthreadç±»çš„å­ç±»
   2. é‡å†™threadç±»ä¸­çš„runæ–¹æ³•
   3. åˆ›å»ºthreadç±»çš„å­ç±»å¯¹è±¡
   4. é€šè¿‡æ­¤å¯¹è±¡è°ƒç”¨start()å¼€å¯çº¿ç¨‹

   æ³¨ï¼šçº¿ç¨‹å¯¹è±¡.start()æ–¹æ³•ï¼Œå¯¹äºåŒä¸€ä¸ªçº¿ç¨‹å¯¹è±¡æ¥è¯´åªèƒ½è°ƒä¸€æ¬¡ã€‚start()æ–¹æ³•çš„ä»»åŠ¡å°±æ˜¯å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹çš„æ ˆç©ºé—´ï¼Œå¼€è¾Ÿç»“æŸåå°±ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œè°ƒç”¨å¤šæ¬¡çº¿ç¨‹æ–¹æ³•éœ€ç”¨å¤šä¸ªå¯¹è±¡å³

   `çº¿ç¨‹å¯¹è±¡1.start()` `çº¿ç¨‹å¯¹è±¡2.start()`

```java
public class CreateThread1 {
    public static void main(String[] args) {
        myThread myThread = new myThread();
        //myThread.run();//ä½¿ç”¨runä»ç„¶æ˜¯å•çº¿ç¨‹
        myThread.start();//ä½¿ç”¨startå¼€å¯çº¿ç¨‹è€Œä¸æ˜¯ä½¿ç”¨runå¼€å¯
        for (int i = 0; i < 1000; i++) {
            System.out.println("ä¸»çº¿ç¨‹:"+i);
        }
    }
}
class myThread extends Thread{
    @Override
    public void run() {
        for (int i = 0; i < 1000; i++) {
            System.out.println("åˆ†çº¿ç¨‹ï¼š"+i);
        }
    }
}
```

   æ–¹å¼äºŒï¼š

1. åˆ›å»ºä¸€ä¸ªå®ç°äº†Runnableæ¥å£çš„ç±»
2. å®ç°ç±»å»å®ç°Runnableä¸­çš„æŠ½è±¡æ–¹æ³•ï¼šrun()
3. åˆ›å»ºæ­¤å®ç°ç±»çš„å¯¹è±¡
4. å°†æ­¤å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’åˆ°Threadç±»çš„æ„é€ å™¨ä¸­ï¼Œåˆ›å»ºThreadç±»çš„å¯¹è±¡
5. é€šè¿‡Threadç±»çš„å¯¹è±¡è°ƒç”¨start()

```java
public static void main(String[] args) {
		myThread thread = new myThread();
    	Thread thread = new Thread(new Runnable({
              @Override
   			 public void run(){
       		 //çº¿ç¨‹æ–¹æ³•
    		}  
        }));
    	thread.start();//å¯åŠ¨çº¿ç¨‹
  }
```



ä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒï¼š

æ–¹å¼äºŒåˆ›å»ºå®ç°Runnableæ¥å£çš„ç±»çš„æ–¹å¼ç›¸æ¯”äºæ–¹å¼ä¸€æ²¡æœ‰å•ç»§æ‰¿æ€§çš„å±€é™æ€§ä¸”æ›´é€‚åˆç”¨äºå¤„ç†å¤šä¸ªçº¿ç¨‹æœ‰å…±äº«èµ„æºçš„æƒ…å†µï¼Œ

## Threadä¸­çš„å¸¸ç”¨æ–¹æ³•

1. `start()`:å¯åŠ¨å½“å‰çº¿ç¨‹ï¼›è°ƒç”¨çº¿ç¨‹ä¸­çš„run()æ–¹æ³•

2. `run()`ï¼šé‡å†™è¯¥æ–¹æ³•ä»¥è®¾ç½®è¯¥çº¿ç¨‹ä¸­çš„åŠŸèƒ½

3. `currentThread()`:é™æ€æ–¹æ³•ï¼Œè¿”å›æ‰§è¡Œå½“å‰ä»£ç çš„çº¿ç¨‹å¯¹è±¡

4. `getName()`:è·å–å½“å‰è¿›ç¨‹çš„åå­—

5. `setName()`:è®¾ç½®å½“å‰è¿›ç¨‹çš„åå­—

5. `getId()`:è·å–çº¿ç¨‹çš„id

6. `yield()`:é‡Šæ”¾CPUçš„ä½¿ç”¨æƒ

7. `join()`:åœ¨çº¿ç¨‹aä¸­è°ƒç”¨çº¿ç¨‹bçš„joinæ–¹æ³•ï¼Œæ­¤æ—¶**çº¿ç¨‹aå°±è¿›å…¥é˜»å¡çŠ¶æ€**ï¼Œå»æ‰§è¡Œçº¿ç¨‹bï¼Œç›´åˆ°çº¿ç¨‹bå®Œå…¨æ‰§è¡Œå®Œä¹‹åï¼Œæ‰å›åˆ°çº¿ç¨‹a

8. `sleep(long milltime)`ï¼šè®©å½“å‰çº¿ç¨‹ç¡çœ æŒ‡å®šçš„milltimeæ¯«ç§’ã€‚æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œåœ¨æŒ‡å®šçš„milltimeæ¯«ç§’æ—¶é—´å†…ï¼Œ**å½“å‰çº¿ç¨‹**æ˜¯é˜»å¡çŠ¶æ€

   ```java
   public class ThreadDemo3 {
       public static void main(String[] args) throws InterruptedException {
           Thread myThread3 = new myThread3();
           myThread3.setName("çº¿ç¨‹ä¸‰");
           myThread3.start();
           Thread.sleep(1000*5);//ç”±äºsleepæ˜¯é™æ€æ–¹æ³•ï¼Œæ‰€ä»¥å®é™…è°ƒç”¨å¯¹è±¡æ˜¯mainçº¿ç¨‹ï¼Œè¿›å…¥ç¡çœ çŠ¶æ€çš„æ˜¯mainçº¿ç¨‹
           System.out.println("ä½ å¥½è¿™æ˜¯mainçº¿ç¨‹!");
       }
   }
   
   class myThread3 extends Thread{
       @Override
       public void run() {
           for (int i = 0; i < 150; i++) {
               System.out.println(i);
           }
       }
   }
   ```

9. `isAlive()`:åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆå¦‚æœå·²æ‰§è¡Œå®Œrunæ–¹æ³•åˆ™ä»£è¡¨ä¸å­˜æ´»ï¼‰

10. `interrupt()`:è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè®©å½“å‰è¿›ç¨‹è§¦å‘`InterruptedException`

```java
public class ThreadDemo4 {
    public static void main(String[] args) {
        myThread4 myThread4 = new myThread4();
        Thread thread = new Thread(myThread4);
        thread.setName("çº¿ç¨‹ä¸€");
        thread.start();
        thread.interrupt();//ä¸­æ–­çº¿ç¨‹threadï¼Œå¹¶è§¦å‘threadä¸­çš„å¼‚å¸¸
    }
}

class myThread4 implements Runnable {

    @Override
    public void run() {

        try {
            Thread.sleep(1000*5);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("å½“å‰çº¿ç¨‹åç§°:"+Thread.currentThread().getName());
    }
}
```

## çº¿ç¨‹çš„è°ƒåº¦

Javaçš„çº¿ç¨‹è°ƒåº¦ç­–ç•¥æ˜¯åŒä¼˜å…ˆçº§çº¿ç¨‹ç»„æˆå…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼ˆå…ˆåˆ°å…ˆæœåŠ¡ï¼‰ï¼Œä½¿ç”¨æ—¶é—´ç‰‡ç­–ç•¥ï¼›å¯¹é«˜ä¼˜å…ˆçº§ï¼Œä½¿ç”¨ä¼˜å…ˆè°ƒåº¦çš„æŠ¢å å¼ç­–ç•¥ã€‚

1. çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼š`MAX_PRIORITYï¼š10`

   â€‹						   `MIN_PRIORITY:1`

   â€‹						  `NORM_PRIORITY:5` é»˜è®¤çš„ä¼˜å…ˆçº§

2. `getPriority()`:è·å–çº¿ç¨‹çš„ä¼˜å…ˆçº§

   `setPriority`:è®¾ç½®çº¿ç¨‹

   æ³¨ï¼šé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹è¦æŠ¢å ä½ä¼˜å…ˆçº§è¿›ç¨‹CPUçš„æ‰§è¡Œæƒã€‚ä½†æ˜¯ä»æ¦‚ç‡ä¸Šè®²ï¼Œé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹é«˜æ¦‚ç‡çš„æƒ…å†µä¸‹è¢«æ‰§è¡Œï¼Œå¹¶ä¸æ„å‘³ç€åªæœ‰å½“é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æ‰§è¡Œå®Œä¹‹åï¼Œä½ä¼˜å…ˆçº§çš„çº¿ç¨‹æ‰æ‰§è¡Œã€‚

## çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ

å’Œäººæœ‰æœ‰é™çš„ç”Ÿå‘½ä¸€æ ·ï¼Œçº¿ç¨‹ä¹Ÿæœ‰ç”Ÿå‘½å‘¨æœŸã€‚äººåœ¨ä¸åŒæ—¶é—´ã€ä¸åŒç¯å¢ƒä¸‹æœ‰ä¸åŒçš„çŠ¶æ€ï¼Œçº¿ç¨‹ä¹Ÿåœ¨ç”Ÿå‘½å‘¨æœŸæœ‰ä¸åŒçš„çŠ¶æ€ã€‚

JDKä¸­ç”¨Thread.Stateç±»å®šä¹‰äº†çº¿ç¨‹çš„å‡ ç§çŠ¶æ€:åˆ›å»ºã€å°±ç»ªã€è¿è¡Œã€é˜»å¡ã€ç»ˆæ­¢ã€‚

Javaçš„çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå›¾(JDK1.5ä¹‹å‰)

![image-20210926151431355](img/image-20210926151431355.png)

JDK1.5ä¹‹å,å°†å°±è¡Œå’Œè¿è¡Œåˆå¹¶ä¸ºRunnableï¼›é˜»å¡çŠ¶æ€ç»†åˆ†ä¸º3ç§ç±»å‹ï¼š`BLOCKED` `TIMED_WAITING` `WAITING`

```JAVA
public enum State {
    /**
     * Thread state for a thread which has not yet started.
     */
    NEW,

    /**
     * Thread state for a runnable thread.  A thread in the runnable
     * state is executing in the Java virtual machine but it may
     * be waiting for other resources from the operating system
     * such as processor.
     */
    RUNNABLE,

    /**
     * Thread state for a thread blocked waiting for a monitor lock.
     * A thread in the blocked state is waiting for a monitor lock
     * to enter a synchronized block/method or
     * reenter a synchronized block/method after calling
     * {@link Object#wait() Object.wait}.
     */
    BLOCKED,

    /**
     * Thread state for a waiting thread.
     * A thread is in the waiting state due to calling one of the
     * following methods:
     * <ul>
     *   <li>{@link Object#wait() Object.wait} with no timeout</li>
     *   <li>{@link #join() Thread.join} with no timeout</li>
     *   <li>{@link LockSupport#park() LockSupport.park}</li>
     * </ul>
     *
     * <p>A thread in the waiting state is waiting for another thread to
     * perform a particular action.
     *
     * For example, a thread that has called <tt>Object.wait()</tt>
     * on an object is waiting for another thread to call
     * <tt>Object.notify()</tt> or <tt>Object.notifyAll()</tt> on
     * that object. A thread that has called <tt>Thread.join()</tt>
     * is waiting for a specified thread to terminate.
     */
    WAITING,

    /**
     * Thread state for a waiting thread with a specified waiting time.
     * A thread is in the timed waiting state due to calling one of
     * the following methods with a specified positive waiting time:
     * <ul>
     *   <li>{@link #sleep Thread.sleep}</li>
     *   <li>{@link Object#wait(long) Object.wait} with timeout</li>
     *   <li>{@link #join(long) Thread.join} with timeout</li>
     *   <li>{@link LockSupport#parkNanos LockSupport.parkNanos}</li>
     *   <li>{@link LockSupport#parkUntil LockSupport.parkUntil}</li>
     * </ul>
     */
    TIMED_WAITING,

    /**
     * Thread state for a terminated thread.
     * The thread has completed execution.
     */
    TERMINATED;
}
```

![image-20230318210118671](img/image-20230318210118671.png)

## çº¿ç¨‹åŒæ­¥

ä½œç”¨ï¼šä½¿å¾—ä¸åŒè¿›ç¨‹åœ¨å¯¹å…±äº«èµ„æºè®¿é—®æ—¶ä¸è¢«å¹²æ‰°åˆ‡æ¢è‡³å…¶ä»–çº¿ç¨‹ä»è€Œå¯¼è‡´é”™è¯¯çš„å‘ç”Ÿã€‚
### synchronized
#### æ–¹å¼ä¸€åŒæ­¥ä»£ç å—

å¦‚æœåŒæ­¥æ–¹æ³•æ˜¯éœ€è¦æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿æ—¶é—´çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå¤šçº¿ç¨‹åœ¨æ’é˜Ÿå¤„ç†åŒæ­¥æ–¹æ³•æ—¶å°±ä¼šç­‰å¾…å¾ˆä¹…ï¼Œä½†æ˜¯ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œå…¶å®å¹¶ä¸æ˜¯æ‰€æœ‰çš„ä»£ç éƒ½éœ€è¦åŒæ­¥å¤„ç†çš„ï¼Œåªæœ‰å¯èƒ½ä¼šå‘ç”Ÿçº¿ç¨‹ä¸å®‰å…¨çš„ä»£ç æ‰éœ€è¦åŒæ­¥ã€‚è¿™æ—¶ï¼Œå¯ä»¥é‡‡ç”¨`synchronized`æ¥ä¿®é¥°è¯­å¥å—è®©å…³é”®çš„ä»£ç è¿›è¡ŒåŒæ­¥ã€‚

```java
synchronized(åŒæ­¥ç›‘è§†å™¨){
    //éœ€è¦è¢«åŒæ­¥çš„ä»£ç å—
}
```

åŒæ­¥ç›‘è§†å™¨ï¼Œä¿—ç§°é”ã€‚ä»»ä½•ä¸€ä¸ªç±»çš„å¯¹è±¡ï¼Œéƒ½èƒ½å……å½“é”ã€‚ä½†æ˜¯è¦ä¿è¯å¤šä¸ªçº¿ç¨‹æ˜¯å…±ç”¨åŒä¸€æŠŠğŸ”’ï¼Œå¦åˆ™æ¯ä¸ªçº¿ç¨‹éƒ½è‡ªå·±æœ‰ä¸ªé”çš„è¯æ— æ³•å®ç°åŒæ­¥æ•ˆæœã€‚ç”±äºåŒæ­¥è¿‡ç¨‹ä¸­ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨CPUä¸Šæ‰§è¡Œï¼Œæ‰€ä»¥å¯¹äºå•ä¸ªCPUæ¥è¯´åœ¨æ‰§è¡ŒåŒæ­¥ä»£ç å—æ—¶ï¼Œæ˜¯å•çº¿ç¨‹å·¥ä½œçš„ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå”®å–è½¦ç¥¨çš„æ¡ˆä¾‹ï¼š

```java
public class sellTicketDemo {
    @Test
    public void testSellTickets() throws InterruptedException {
        sellTicketService sellTicketService = new sellTicketService();
        window window = new window(sellTicketService);
        Thread window1 = new Thread(window);
        window1.setName("çª—å£ä¸€");
        Thread window2 = new Thread(window);
        window2.setName("çª—å£äºŒ");
        Thread window3 = new Thread(window);
        window3.setName("çª—å£ä¸‰");//ä¸‰ä¸ªçª—å£çº¿ç¨‹
        window1.start();window2.start();window3.start();
        Thread.sleep(1000*20);
    }
}
class window implements Runnable{
    private sellTicketService service;
    public window(sellTicketService service) {
        this.service = service;
    }
    @Override
    public void run() {
        service.sellTicket();
    }
}
/**
 * å°†å”®ç¥¨æœåŠ¡å•ç‹¬ä½œä¸ºä¸€ä¸ªç±»
 */
class sellTicketService{
    private int tickets = 100;//åˆå§‹ç¥¨æ•°é‡
    public void sellTicket(){
        while (true){
            synchronized (this){//thisè¡¨ç¤ºè°ƒç”¨è¯¥ç±»çš„å¯¹è±¡
                if(tickets == 0){
                    System.out.println("ç¥¨å·²å”®ç£¬!");
                    break;
                }
                try {
                    Thread.sleep(100);
                    System.out.println(Thread.currentThread().getName()+":å–å‡ºç¥¨ï¼Œç¥¨å·ä¸ºï¼š"+ (100-tickets));
                    tickets--;
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}
```

#### æ–¹å¼äºŒï¼šåŒæ­¥æ–¹æ³•

å¦‚æœæ“ä½œå…±äº«æ•°æ®çš„ä»£ç åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥å°†è¿™ä¸ªæ–¹æ³•è®¾ç½®ä¸ºåŒæ­¥çš„ã€‚

#### ç±»é”

ç±»é”ï¼Œå°±æ˜¯å¯¹äºåŒä¸€ä¸ªç±»ä¸­çš„**é™æ€æ–¹æ³•ä½¿ç”¨synchronizedä¿®é¥°**åï¼Œè¯¥æ–¹æ³•å°±æ˜¯ç”¨ç±»åŠ é”çš„æ–¹æ³•ï¼Œå› ä¸ºé™æ€æ–¹æ³•æ˜¯éšç€ç±»åŠ è½½è€ŒåŠ è½½çš„ï¼Œæ‰€ä»¥synchronizedä¿®é¥°çš„é™æ€æ–¹æ³•å’Œéé™æ€æ–¹æ³•ä¸åŒä¹‹å¤„åœ¨äºï¼šé™æ€æ–¹æ³•ç”±ç±»åŠ é”ï¼Œåªè¦ä¸åŒçº¿ç¨‹ä½¿ç”¨è¯¥ç±»è¿›è¡Œè°ƒç”¨å°±æ˜¯åŒæ­¥çŠ¶æ€ï¼›è€Œéé™æ€æ–¹æ³•æ˜¯å¯¹é”ï¼Œé’ˆå¯¹çš„æ˜¯åŒä¸€å¯¹è±¡å‘ˆç°éåŒæ­¥çŠ¶æ€ã€‚


#### å¤„ç†Runnableçš„çº¿ç¨‹å®‰å…¨é—®é¢˜

å°†å¤„ç†å…±äº«èµ„æºçš„æ–¹æ³•ç”¨`synchronized`ä¿®é¥°ï¼Œå³ç”¨é»˜è®¤åŒæ­¥ç›‘è§†å™¨ä¸­çš„thisæ˜¯å½“å‰ç±»çš„å¯¹è±¡ã€‚

```java
private  synchronized void sell(){//é»˜è®¤åŒæ­¥ç›‘è§†å™¨ï¼šthis
    if(ticket>0){
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            System.out.println(e.getMessage());
        }
        System.out.println(Thread.currentThread().getName()+"å–å‡ºè½¦ç¥¨:"+ticket);
        ticket--;
    }
}
```

#### å¤„ç†ç»§æ‰¿Threadç±»çš„çº¿ç¨‹å®‰å…¨é—®é¢˜

```java
private static synchronized void sell(){//ç”±äºæ˜¯é™æ€ï¼ŒåŒæ­¥ç›‘è§†å™¨æŒ‡ä»£çš„æ˜¯å½“å‰çš„ç±»
//private  void sell{ é”™è¯¯çš„å†™æ³•  ä¸åŒçš„è¿›ç¨‹æ˜¯ä¸åŒçš„å¯¹è±¡,è€ŒthisæŒ‡ä»£çš„æ˜¯å½“å‰å¯¹è±¡
    if(ticket>0){
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            System.out.println(e.getMessage());
        }
        System.out.println(Thread.currentThread().getName()+"å–å‡ºè½¦ç¥¨:"+ticket);
        ticket--;
    }
}
```

æ€»ç»“ï¼š

1. åŒæ­¥æ–¹æ³•ä»ç„¶æ¶‰åŠåˆ°åŒæ­¥ç›‘è§†å™¨ï¼Œåªæ˜¯ä¸éœ€è¦æˆ‘ä»¬æ˜¾å¼çš„å£°æ˜ã€‚
2. éé™æ€çš„åŒæ­¥æ–¹æ³•ï¼ŒåŒæ­¥ç›‘è§†å™¨æ˜¯ï¼šthis å½“å‰å¯¹è±¡
3. é™æ€çš„åŒæ­¥æ–¹æ³•ï¼ŒåŒæ­¥ç›‘è§†å™¨æ˜¯ï¼šå½“å‰ç±»æœ¬èº«
4. åœ¨ç»§æ‰¿Threadç±»çš„çº¿ç¨‹åŒæ­¥ä¸­ï¼Œæ…ç”¨thiså……å½“åŒæ­¥ç›‘æ§å™¨ï¼Œè€ƒè™‘ä½¿ç”¨å½“å‰ç±»å……å½“åŒæ­¥ç›‘æ§å™¨

### lock

1. å®ä¾‹åŒ–ä¸€ä¸ªReentrantLockå¯¹è±¡
2. åœ¨è¿›å…¥åŒæ­¥ä»£ç å—å‰è°ƒç”¨é”å®šæ–¹æ³•ï¼š`lock()`
3. åœ¨åŒæ­¥ä»£ç å—ç»“æŸä¹‹åè°ƒç”¨è§£é”æ–¹æ³•:`unlock()`

```java
class Window implements Runnable{
    private int tickets = 100;
    //1. å®ä¾‹åŒ–ä¸€ä¸ªReentrantLockå¯¹è±¡
    private ReentrantLock lock = new ReentrantLock(true);//ç©ºå‚é»˜è®¤æ˜¯false
    @Override
    public void run() {
        while(true){
            try{
                //2. è°ƒç”¨é”å®šæ–¹æ³•ï¼šlock()
                lock.lock();
                if(tickets > 0){
                    System.out.println(Thread.currentThread().getName()+"å–å‡ºè½¦ç¥¨ï¼š"+ tickets);
                    tickets--;
                }
                else
                    break;
            }finally {
                //3. è°ƒç”¨è§£é”æ–¹æ³•ï¼šunlock()
                lock.unlock();
            }

        }
    }
}
```

### synchronizedå’Œlockçš„åŒºåˆ«

1. synchronizedæœºåˆ¶åœ¨æ‰§è¡Œå®Œç›¸åº”çš„åŒæ­¥ä»£ç åï¼Œè‡ªåŠ¨é‡Šæ”¾åŒæ­¥ç›‘è§†å™¨
2. lockéœ€è¦æ‰‹åŠ¨çš„å¯åŠ¨é”å®š`lock()`å’Œè§£é”`unlock()`
3. Lockåªæœ‰ä»£ç å—é”ï¼Œsynchronizedæœ‰ä»£ç å—é”å’Œæ–¹æ³•é”

### ä¿è¯å¯è§æ€§çš„å…³é”®å­—â€”â€”volatile

åœ¨å¤šçº¿ç¨‹äº‰æŠ¢å¯¹è±¡çš„æ—¶å€™ï¼Œå¤„ç†è¯¥å¯¹è±¡çš„å˜é‡çš„æ–¹å¼æ˜¯åœ¨ä¸»å†…å­˜ä¸­è¯»å–è¯¥å˜é‡çš„å€¼åˆ°çº¿ç¨‹ç§æœ‰çš„å†…å­˜ä¸­ï¼Œç„¶åå¯¹è¯¥å˜é‡åšå¤„ç†ï¼Œå¤„ç†åå°†å€¼åœ¨å†™å…¥åˆ°ä¸»å†…å­˜ä¸­ã€‚ä¸Šé¢ä¸¾çš„ä¾‹å­ï¼Œä¹‹æ‰€ä»¥å‡ºç°ç»“æœä¸é¢„æœŸä¸ä¸€è‡´éƒ½æ˜¯å› ä¸ºçº¿ç¨‹è‡ªå·±å°†å€¼å¤åˆ¶åˆ°è‡ªå·±çš„ç§æœ‰æ ˆåä¿®æ”¹ç»“æœè€Œä¸çŸ¥é“å…¶ä»–çº¿ç¨‹çš„ä¿®æ”¹ç»“æœã€‚å¦‚æœæˆ‘ä»¬ä¸ç”¨åŒæ­¥çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªèƒ½ä¿æŒå¯è§çš„ï¼ŒçŸ¥é“å…¶ä»–çº¿ç¨‹ä¿®æ”¹ç»“æœçš„æ–¹æ³•ã€‚JDKæä¾›äº†`volatile`å…³é”®å­—ï¼Œæ¥ä¿æŒå¯è§æ€§ï¼Œå…³é”®å­—volatileçš„ä½œç”¨æ˜¯å¼ºåˆ¶ä»å…¬å…±å †æ ˆä¸­å–å¾—å˜é‡çš„å€¼ï¼Œè€Œä¸æ˜¯ä»çº¿ç¨‹ç§æœ‰æ•°æ®æ ˆä¸­å–å¾—å˜é‡å€¼ã€‚ä½†æ˜¯è¯¥å…³é”®å­—å¹¶ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä»¥äº‰æŠ¢ä¸€ä¸ªå¯¹è±¡ä¸­çš„countå˜é‡æ¥çœ‹ä¸‹å›¾çš„å…·ä½“è¯´æ˜ï¼š
![å˜é‡åœ¨çº¿ç¨‹ç§æœ‰æ ˆä¸ä¸»å†…å­˜çš„å…³ç³»](http://images.cnblogs.com/cnblogs_com/aigongsi/201204/201204011757234696.jpg)
> java åƒåœ¾å›æ”¶æ•´ç†ä¸€æ–‡ä¸­ï¼Œæè¿°äº†jvmè¿è¡Œæ—¶åˆ»å†…å­˜çš„åˆ†é…ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªå†…å­˜åŒºåŸŸæ˜¯jvmè™šæ‹Ÿæœºæ ˆï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹è¿è¡Œæ—¶éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ ˆï¼Œçº¿ç¨‹æ ˆä¿å­˜äº†çº¿ç¨‹è¿è¡Œæ—¶å€™å˜é‡å€¼ä¿¡æ¯ã€‚å½“çº¿ç¨‹è®¿é—®æŸä¸€ä¸ªå¯¹è±¡æ—¶å€™å€¼çš„æ—¶å€™ï¼Œé¦–å…ˆé€šè¿‡å¯¹è±¡çš„å¼•ç”¨æ‰¾åˆ°å¯¹åº”åœ¨å †å†…å­˜çš„å˜é‡çš„å€¼ï¼Œç„¶åæŠŠå †å†…å­˜å˜é‡çš„å…·ä½“å€¼loadåˆ°çº¿ç¨‹æœ¬åœ°å†…å­˜ä¸­ï¼Œå»ºç«‹ä¸€ä¸ªå˜é‡å‰¯æœ¬ï¼Œä¹‹åçº¿ç¨‹å°±ä¸å†å’Œå¯¹è±¡åœ¨å †å†…å­˜å˜é‡å€¼æœ‰ä»»ä½•å…³ç³»ï¼Œè€Œæ˜¯ç›´æ¥ä¿®æ”¹å‰¯æœ¬å˜é‡çš„å€¼ï¼Œåœ¨ä¿®æ”¹å®Œä¹‹åçš„æŸä¸€ä¸ªæ—¶åˆ»ï¼ˆçº¿ç¨‹é€€å‡ºä¹‹å‰ï¼‰ï¼Œè‡ªåŠ¨æŠŠçº¿ç¨‹å˜é‡å‰¯æœ¬çš„å€¼å›å†™åˆ°å¯¹è±¡åœ¨å †ä¸­å˜é‡ã€‚è¿™æ ·åœ¨å †ä¸­çš„å¯¹è±¡çš„å€¼å°±äº§ç”Ÿå˜åŒ–äº†ã€‚

volatileåœ¨æ­¤è¿‡ç¨‹ä¸­çš„å…·ä½“è¯´æ˜å¦‚ä¸‹ï¼š
>read and load ä»ä¸»å­˜å¤åˆ¶å˜é‡åˆ°å½“å‰å·¥ä½œå†…å­˜
>use and assign  æ‰§è¡Œä»£ç ï¼Œæ”¹å˜å…±äº«å˜é‡å€¼
>store and write ç”¨å·¥ä½œå†…å­˜æ•°æ®åˆ·æ–°ä¸»å­˜ç›¸å…³å†…å®¹
>å…¶ä¸­use and assign å¯ä»¥å¤šæ¬¡å‡ºç°
>ä½†æ˜¯è¿™ä¸€äº›æ“ä½œå¹¶ä¸æ˜¯åŸå­æ€§ï¼Œä¹Ÿå°±æ˜¯ åœ¨read loadä¹‹åï¼Œå¦‚æœä¸»å†…å­˜countå˜é‡å‘ç”Ÿä¿®æ”¹ä¹‹åï¼Œçº¿ç¨‹å·¥ä½œå†…å­˜ä¸­çš„å€¼ç”±äºå·²ç»åŠ è½½ï¼Œä¸ä¼šäº§ç”Ÿå¯¹åº”çš„å˜åŒ–ï¼Œæ‰€ä»¥è®¡ç®—å‡ºæ¥çš„ç»“æœä¼šå’Œé¢„æœŸä¸ä¸€æ ·å¯¹äºvolatileä¿®é¥°çš„å˜é‡ï¼Œjvmè™šæ‹Ÿæœºåªæ˜¯ä¿è¯ä»ä¸»å†…å­˜åŠ è½½åˆ°çº¿ç¨‹å·¥ä½œå†…å­˜çš„å€¼æ˜¯æœ€æ–°çš„ä¾‹å¦‚å‡å¦‚çº¿ç¨‹1ï¼Œçº¿ç¨‹2 åœ¨è¿›è¡Œread,load æ“ä½œä¸­ï¼Œå‘ç°ä¸»å†…å­˜ä¸­countçš„å€¼éƒ½æ˜¯5ï¼Œé‚£ä¹ˆéƒ½ä¼šåŠ è½½è¿™ä¸ªæœ€æ–°çš„å€¼åœ¨çº¿ç¨‹1å †countè¿›è¡Œä¿®æ”¹ä¹‹åï¼Œä¼šwriteåˆ°ä¸»å†…å­˜ä¸­ï¼Œä¸»å†…å­˜ä¸­çš„countå˜é‡å°±ä¼šå˜ä¸º6çº¿ç¨‹2ç”±äºå·²ç»è¿›è¡Œread,loadæ“ä½œï¼Œåœ¨è¿›è¡Œè¿ç®—ä¹‹åï¼Œä¹Ÿä¼šæ›´æ–°ä¸»å†…å­˜countçš„å˜é‡å€¼ä¸º6å¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹åŠæ—¶ç”¨volatileå…³é”®å­—ä¿®æ”¹ä¹‹åï¼Œè¿˜æ˜¯ä¼šå­˜åœ¨å¹¶å‘çš„æƒ…å†µã€‚

ä¸Šè¿°å¯¹äºvolatileçš„è§£æå‡æ‘˜è‡ª[javaä¸­volatileå…³é”®å­—çš„å«ä¹‰](http://www.cnblogs.com/aigongsi/archive/2012/04/01/2429166.html)

## çº¿ç¨‹å®‰å…¨æ¨¡å¼çš„å•ä¾‹æ¨¡å¼

```java
/*
ä½¿ç”¨åŒæ­¥æœºåˆ¶å°†å•ä¾‹æ¨¡å¼ä¸­çš„æ‡’æ±‰æ¨¡å¼æ”¹ä¸ºçº¿ç¨‹å®‰å…¨çš„
 */
public class BankTest {
}
//æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼
class Bank{
    private Bank(){};
    private static Bank instance = null;

    //åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¼šæœ‰å¤šä¸ªçº¿ç¨‹è°ƒç”¨getInstanceæ–¹æ³•ï¼Œå…¶ä¸­instanceæ˜¯å…±äº«èµ„æº
    public static synchronized Bank getInstance(){
       if(instance == null)
           instance = new Bank();
        return instance;
    }
}
```

```java
//æ–¹å¼ä¸€ å°†getInstanceåŠ ä¸Šsynchronizedå…³é”®å­—
   public static synchronized Bank getInstance(){
      if(instance == null)
            instance = new Bank();
       return instance;
    }
```
```java
// æ–¹å¼äºŒ  å°†å¾…åŒæ­¥çš„ä»£ç åŠ synchronizedåŒ…ä½
//ç¼ºç‚¹ï¼šæ•ˆç‡è¾ƒä½  å› ä¸ºæ¯ä¸ªçº¿ç¨‹åœ¨åˆ¤æ–­instanceæ˜¯å¦ä¸ºç©ºéœ€è¦åˆ›å»ºå®ä¾‹æ—¶å…¶å®ƒè¿›ç¨‹éƒ½è¦ç­‰å¾…
    public static  Bank getInstance(){
        synchronized (Bank.class) {
            if(instance == null)
                instance = new Bank();
            return instance;
        }
    }
```
```java
//æ–¹å¼ä¸‰ æ”¹è‰¯æ–¹å¼äºŒï¼Œå°†çº¿ç¨‹åˆ¤æ–­æ˜¯éç©ºç„¶åå–å‡ºå®ä¾‹è¿™ç§æƒ…å†µå¿«ä¸€ç‚¹ï¼Œå°†å®ƒä»åŒæ­¥å—ä¸­ç§»é™¤ï¼›è¿™æ ·çš„è¯å¯ä»¥é¿å…å•ä¾‹éç©ºæ—¶çº¿ç¨‹ä»ç„¶ç­‰å¾…çš„æƒ…å†µ
public static  Bank getInstance(){
    if(instance != null ) return instance;
    synchronized (Bank.class) {
        if(instance == null)
            instance = new Bank();
        return instance;
    }
}
```



## çº¿ç¨‹çš„æ­»é”

> ä¸åŒçš„çº¿ç¨‹åˆ†åˆ«å ç”¨å¯¹æ–¹éœ€è¦çš„åŒæ­¥èµ„æºä¸æ”¾å¼ƒï¼Œéƒ½åœ¨ç­‰å¾…å¯¹æ–¹æ”¾å¼ƒè‡ªå·±éœ€è¦çš„åŒæ­¥èµ„æºï¼Œå°±å½¢æˆäº†çº¿ç¨‹çš„æ­»é”ã€‚
>
> å‡ºç°æ­»é”åï¼Œä¸ä¼šå‡ºç°å¼‚å¸¸å’Œæç¤ºï¼Œåªæ˜¯æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡æ–¹æ³•ï¼Œæ— æ³•ç»§ç»­

## çº¿ç¨‹é€šä¿¡

> é€šè¿‡çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œå¯ä»¥è®©ä¸åŒçš„çº¿ç¨‹ä¹‹é—´åä½œå®Œæˆä¸€ä¸ªä»»åŠ¡ã€‚

`wait()`:æ‰§è¡Œæ­¤æ–¹æ³•ï¼Œå°±å°†å½“å‰è¿›ç¨‹å˜æˆé˜»å¡çŠ¶æ€ï¼Œå¹¶**é‡Šæ”¾åŒæ­¥ç›‘è§†å™¨**ï¼Œç›´åˆ°ç­‰åˆ°notifyçš„é€šçŸ¥

`nofity()`:å”¤é†’ä¸€ä¸ªè¢«waitçš„çº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¢«waitï¼Œåˆ™å”¤é†’ä¼˜å…ˆçº§æœ€é«˜çš„é‚£ä¸€ä¸ªã€‚å¦‚æœä¼˜å…ˆçº§ç›¸åŒï¼Œåˆ™éšæœºå”¤é†’ä¸€ä¸ª

`nofityAll()`:å”¤é†’æ‰€æœ‰è¢«waitçš„çº¿ç¨‹

æ³¨ï¼š

1. wait notify notifyAllä¸‰ä¸ªæ–¹æ³•å¿…é¡»åœ¨**åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥ä»£ç å—ä¸­è°ƒç”¨**
2. wait notify notifyAllçš„è°ƒç”¨å¯¹è±¡å¿…é¡»æ˜¯**åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥ä»£ç å—ä¸­çš„åŒæ­¥ç›‘è§†å™¨**ï¼Œå¦‚æœä¸åŒä¼šå‡ºç°`illegalMonitorStateException`å¼‚å¸¸
3. wait notify notifyAll ä¸‰ä¸ªæ–¹æ³•æ˜¯å®šä¹‰åœ¨Objectç±»ä¸­
4. wait()å’Œsleep()çš„ä¸åŒï¼š
   1. æ–¹æ³•å£°æ˜ä½ç½®ä¸åŒï¼šThreadç±»ä¸­å£°æ˜äº†sleep()ï¼ŒObjectç±»ä¸­å£°æ˜äº†wait()
   2. è°ƒç”¨è¦æ±‚ä¸åŒï¼šsleep()å¯ä»¥åœ¨ä»»ä½•åœºæ™¯ä¸‹è°ƒç”¨ï¼Œè€Œwait()åªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥ä»£ç å—ä¸­è°ƒç”¨
   3. å¦‚æœä¸¤ä¸ªæ–¹æ³•éƒ½åœ¨åŒæ­¥ç›‘è§†å™¨ä¸­ï¼Œ**wait()ä¼šåœ¨é˜»å¡çº¿ç¨‹åå¯ä»¥è¢«é€šçŸ¥å”¤é†’å¹¶é‡Šæ”¾é”ï¼Œè€Œsleep()åœ¨é˜»å¡ä¸ä¼šé‡Šæ”¾é”**ã€‚

æ ¹æ®é˜»å¡æ–¹å¼çš„ä¸åŒï¼Œå¯ä»¥å°†é˜»å¡ç»†åˆ†ä¸º3ç§ï¼š

* ç­‰å¾…é˜»å¡ï¼šè¿è¡Œçš„çº¿ç¨‹æ‰§è¡Œwaitæ–¹æ³•ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼›
* åŒæ­¥é˜»å¡ï¼šè¿è¡Œçš„çº¿ç¨‹åœ¨è·å–å¯¹è±¡çš„åŒæ­¥é”æ—¶ï¼Œè‹¥è¯¥åŒæ­¥é”è¢«åˆ«çš„çº¿ç¨‹å ç”¨ï¼Œåˆ™JVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥é”æ± å½“ä¸­ã€‚
* å…¶ä»–é˜»å¡ï¼š è¿è¡Œçš„çº¿ç¨‹æ‰§è¡Œäº†`Thread.sleep`æˆ–è€…`join`æ–¹æ³•ï¼Œæˆ–è€…å‘å‡ºI/Oè¯·æ±‚æ—¶ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹ç½®ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“`sleep()`çŠ¶æ€è¶…æ—¶ã€`join()`ç­‰å¾…çº¿ç¨‹ç»ˆæ­¢ï¼Œæˆ–è€…è¶…æ—¶ã€æˆ–è€…I/Oå¤„ç†å®Œæ¯•æ—¶ï¼Œçº¿ç¨‹é‡æ–°è½¬å…¥å¯è¿è¡ŒçŠ¶æ€ã€‚

### æ¡ˆä¾‹1 çº¿ç¨‹äº¤æ›¿æ‰“å°

```java
/**
 * ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹æ‰“å°1-100ã€‚çº¿ç¨‹1å’Œçº¿ç¨‹2äº¤æ›¿æ‰“å°
 */
public class PrintNumberInTurn {
    public static void main(String[] args) {
        PrintNumber2 printNumber = new PrintNumber2();
        Thread thread1 = new Thread(printNumber, "çº¿ç¨‹ä¸€");
        Thread thread2 = new Thread(printNumber, "çº¿ç¨‹äºŒ");
        thread1.start();thread2.start();
    }
}

/**
 * å®ç°å½¢å¼1ï¼šçº¿ç¨‹ä¸€å’Œçº¿ç¨‹äºŒäº¤æ›¿æ‰“å°ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨wait()ç©ºå‚æ–¹æ³•çš„è¯ï¼Œçº¿ç¨‹ä¼šä¸€ç›´é˜»å¡åœ¨é‚£;ä½¿ç”¨wait(long timeout)æŒ‡å®šæœ‰é™ç­‰å¾…æ—¶é—´è§£å†³
 */
class PrintNumber1 implements Runnable{
    private int number = 1;

    @Override
    public void run() {
        while(true){
            if(number <= 100) {
                synchronized (this) {
                    notify();
                    try {
                        Thread.sleep(50);
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                    System.out.println(Thread.currentThread().getName() + "æ‰“å°:" + number);
                    number++;
                    try {
//                        wait(500);  çº¿ç¨‹å¦‚æœæ²¡æœ‰è¢«notifyå”¤é†’çš„è¯ï¼Œ500msåè‡ªåŠ¨å”¤é†’
                        wait();
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                }
            }else {
                break;
            }
        }
    }
}

/**
 * å®ç°å½¢å¼2ï¼šçº¿ç¨‹ä¸€å’Œçº¿ç¨‹äºŒäº¤æ›¿æ‰“å°ï¼Œåœ¨ifå’Œelseä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ä¸­éƒ½åŠ ä¸Šnotifyï¼Œä¿è¯å†æœ€åä¸€ä¸ªæ•°æ‰“å°åï¼Œå¦ä¸€ä¸ªwaitçš„çº¿ç¨‹èƒ½åŠæ—¶è¢«å”¤é†’
 */
class PrintNumber2 implements Runnable{
    private int number = 1;

    @Override
    public void run() {
        while(true){
            synchronized (this) {
                if(number <= 100) {
                    notify();
                    try {
                        Thread.sleep(50);
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                    System.out.println(Thread.currentThread().getName() + "æ‰“å°:" + number);
                    number++;
                    try {
                        wait();
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                }else {
                    notify();
                    break;
                }
            }
        }
    }
}
```

### æ¡ˆä¾‹2 æ¶ˆè´¹è€…ç”Ÿäº§è€…

>```
>ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼š
>ç”Ÿäº§è€…å°†äº§å“äº¤ç»™åº—å‘˜(Clerk),è€Œæ¶ˆè´¹è€…(Consumer)ä»åº—å‘˜å¤„å–èµ°äº§å“ï¼Œåº—å‘˜ä¸€æ¬¡åªèƒ½æŒæœ‰å›ºå®šæ•°é‡çš„äº§å“ï¼ˆ20ä¸ªï¼‰ã€‚
>å¦‚æœç”Ÿäº§è€…è¯•å›¾ç”Ÿæˆæ›´å¤šçš„äº§å“ï¼Œåº—å‘˜ä¼šå«ç”Ÿäº§è€…åœä¸€ä¸‹ï¼Œå¦‚æœåº—ä¸­æœ‰ç©ºä½æ”¾äº§å“äº†å†é€šçŸ¥ç”Ÿäº§è€…ç»§ç»­ç”Ÿäº§ï¼›
> å¦‚æœåº—ä¸­æ²¡æœ‰äº§å“äº†ï¼Œåº—å‘˜ä¼šå‘Šè¯‰æ¶ˆè´¹è€…ç­‰ä¸€ä¸‹ï¼Œå¦‚æœåº—ä¸­æœ‰äº§å“äº†å†é€šçŸ¥æ¶ˆè´¹è€…æ¥å–èµ°äº§å“
>```

```java
public class ProducerConsumer {
    public static void main(String[] args) {
        Shop shop = new Shop();
        Producer producer = new Producer(shop);
        Consumer consumer1 = new Consumer(shop);
        Consumer consumer2 = new Consumer(shop);
        Thread thread1 = new Thread(producer, "ç”Ÿäº§è€…");
        Thread thread2 = new Thread(consumer1, "æ¶ˆè´¹è€…1");
        Thread thread3 = new Thread(consumer2, "æ¶ˆè´¹è€…2");
        thread1.start();thread2.start();thread3.start();
    }
}

class Shop{
    private int products = 0;


    /**
     * ç”Ÿäº§è€…ç”Ÿäº§äº§å“
     */
    public synchronized int produce(){
        if(products >= 20){
            System.out.println("å½“å‰äº§å“æ•°é‡å·²è¾¾åˆ°æœ€å¤§å­˜å‚¨å®¹é‡,æ— æ³•ç”Ÿäº§!");
            notify();//å”¤é†’æ¶ˆè´¹è€…çº¿ç¨‹
            try {
                wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }else{
            try {
                Thread.sleep(500);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            products++;
            System.out.println(Thread.currentThread().getName()+"ç”Ÿäº§äº†ä¸€ä¸ªäº§å“ã€‚å½“å‰äº§å“æ•°é‡ä¸º:"+products);
        }
        return products;
    }

    /**
     * æ¶ˆè´¹è€…æ¶ˆè´¹äº§å“
     * @param counts
     * @return 0:è¡¨ç¤ºå½“å‰äº§å“æ•°é‡ä¸è¶³ä»¥æ¶ˆè´¹è€…æ¶ˆè´¹  å…¶ä»–å€¼ï¼šæ¶ˆè´¹äº§å“çš„æ•°é‡
     */
    public synchronized int consume(int counts){
        if(products-counts < 0){
            System.out.println(Thread.currentThread().getName()+"æ¶ˆè´¹"+counts+"ä»¶å•†å“,åº“å­˜ä¸è¶³,æ— æ³•æ¶ˆè´¹");
            notify();//å”¤é†’ç”Ÿäº§è€…çº¿ç¨‹
            try {
                wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            return 0;
        }else{
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            products -= counts;
            System.out.println(Thread.currentThread().getName()+"æ¶ˆè´¹"+counts+"ä»¶å•†å“,å‰©ä½™åº“å­˜æ•°é‡ï¼š"+products);
            return counts;
        }
    }
}

/**
 * ç”Ÿäº§è€…è¿›ç¨‹
 */
class Producer implements Runnable{
    private Shop shop;

    public Producer(Shop shop) {
        this.shop = shop;
    }

    @Override
    public void run() {
        while (true){
            shop.produce();
        }
    }
}

/**
 * æ¶ˆè´¹è€…è¿›ç¨‹
 */
class Consumer implements Runnable{
    private Shop shop;

    public Consumer(Shop shop) {
        this.shop = shop;
    }

    @Override
    public void run() {
        while (true){
            Random random = new Random();
            int counts = random.nextInt(10) +1;//è·å¾—[1,10]çš„éšæœºæ•°
            shop.consume(counts);
        }
    }
}
```

## æ–°å¢çº¿ç¨‹åˆ›å»ºæ–¹å¼

### ä¸€ã€å®ç°Callableæ¥å£

ä¸ä½¿ç”¨Runnableç›¸æ¯”ï¼ŒCallableåŠŸèƒ½æ›´å¼ºå¤§äº›ã€‚

- ç›¸æ¯”run()æ–¹æ³•ï¼Œå¯ä»¥**æœ‰è¿”å›å€¼**
- æ–¹æ³•å¯ä»¥æŠ›å‡ºå¼‚å¸¸
- æ”¯æŒæ³›å‹çš„è¿”å›å€¼
- éœ€è¦å€ŸåŠ©FutureTaskç±»ï¼Œæ¯”å¦‚è·å–è¿”å›ç»“æœ

#### æ­¥éª¤

1.åˆ›å»ºå®ç°Callableæ¥å£çš„å®ç°ç±»ï¼Œé‡å†™callæ–¹æ³•ï¼Œå°†çº¿ç¨‹éœ€æ‰§è¡Œçš„æ“ä½œæ–¹æ³•å†™åœ¨callæ–¹æ³•ä¸­
 ```java
   class numThread implements Callable{
       @Override
       public Object call() throws Exception {
       }
   }
 ```

2. åˆ›å»ºä¸€ä¸ªå®ç°ç±»çš„å¯¹è±¡

```java
numThread num = new numThread();
```

3. åˆ›å»ºfutureTaskç±»çš„å¯¹è±¡ï¼Œå¹¶å°†å®ç°ç±»å¯¹è±¡ä½œä¸ºæ„é€ å™¨å‚æ•°

```java
FutureTask futureTask = new FutureTask(num);
```

4. åˆ›å»ºä¸€ä¸ªThreadç±»å¯¹è±¡ï¼Œå¹¶ç”¨futureTaskç±»å¯¹è±¡ä½œä¸ºå‚æ•°ç„¶åè°ƒç”¨startæ–¹æ³•

```java
new Thread(futureTask).start();//å¼€å¯çº¿ç¨‹
```

5. ï¼ˆå¯é€‰ï¼‰get()è¿”å›å€¼å³ä¸ºFutureTaskæ„é€ å™¨å‚æ•°Callableå®ç°ç±»é‡å†™çš„callæ–¹æ³•çš„è¿”å›å€¼

```java
Object result = futureTask.get();
```

### äºŒã€çº¿ç¨‹æ± 

> æå‰åˆ›å»ºå¥½å¤šä¸ªçº¿ç¨‹ï¼Œç»„æˆçº¿ç¨‹æ± ï¼Œä½¿ç”¨æ—¶ç›´æ¥è·å–ï¼Œä½¿ç”¨å®Œåæ”¾å›æ± ä¸­ï¼Œå¯ä»¥é¿å…é¢‘ç¹åˆ›å»ºçº¿ç¨‹çš„èŠ±é”€ï¼Œå®ç°é‡å¤åˆ©ç”¨ã€‚
>
> 1. æé«˜å“åº”é€Ÿåº¦
> 2. é™ä½èµ„æºæ¶ˆè€—
> 3. é€šè¿‡ä¸€äº›å‚æ•°å¦‚æ ¸å¿ƒæ± å¤§å°ã€æœ€å¤§çº¿ç¨‹æ•°ã€çº¿ç¨‹æ— ä»»åŠ¡æŒç»­æ—¶é—´ç­‰æŒ‡æ ‡ä¾¿äºçº¿ç¨‹ç®¡ç†

#### æ­¥éª¤

1. ç”³è¯·æŒ‡å®šå¤§å°çš„çº¿ç¨‹æ± 

```java
ExecutorService service = Executors.newFixedThreadPool(10);
```

2. æ‰§è¡ŒæŒ‡å®šçº¿ç¨‹çš„æ“ä½œï¼Œå¯ä»¥æ˜¯Runnableæˆ–Callableç±»å®ç°ç±»çš„å¯¹è±¡

```java
service.execute(new NumThread());//é€‚ç”¨äºRunnableæ¥å£çº¿ç¨‹
service.submit();//é€‚ç”¨äºCallableæ¥å£çº¿ç¨‹
```

3. è®¾ç½®ä¸€äº›çº¿ç¨‹æ± å‚æ•°å¦‚æ ¸å¿ƒæ± å¤§å°ã€æœ€å¤§çº¿ç¨‹æ•°ç­‰

```java
ThreadPoolExecutor executor = (ThreadPoolExecutor)service;//serviceå®é™…ä¸Šæ˜¯ThreadPoolExecutorç±»
executor.setCorePoolSize(10);
```

4. å…³é—­çº¿ç¨‹æ± 

```java
service.shutdown();
```

