## 文件上传和下载

### 文件下载

```xml
<a th:href="@{/testDown}">测试下载文件</a>
```

```java
@RequestMapping("/testDown")
public ResponseEntity<byte[]> testResponseEntity(HttpSession session) throws IOException {
    //获取ServletContext对象
    ServletContext servletContext = session.getServletContext();
    //获取服务器中文件的真实路径
    String realPath = servletContext.getRealPath("/static/img/photo1.jpg");
    System.out.println(realPath);
    //创建输入流
    InputStream is = new FileInputStream(realPath);
    //创建字节数组
    byte[] bytes = new byte[is.available()];//available方法获取当前输入流的所有字节数
    //将流读到字节数组中
    is.read(bytes);
    //创建HttpHeaders对象设置响应头信息
    MultiValueMap<String,String> headers = new HttpHeaders();//headers响应头由键值对信息组成<String,String>
    //设置要下载方式以及下载文件的名字
    headers.add("Content-Disposition","attachment;filename=photo1.jpg");//信息表示以附件的形式下载文件名为photo1.jpg文件
    //设置响应状态码
    HttpStatus statusCode = HttpStatus.OK;
    //创建ResponseEntity对象
    ResponseEntity<byte[]> responseEntity = new ResponseEntity<>(bytes, headers, statusCode);
    //关闭输入流
    is.close();
    return responseEntity;
}
```

### 文件上传

文件上传要求form表单的请求方式必须为post，并且添加属性enctype="multipart/form-data"。SpringMVC中将上传的文件封装到MultipartFile对象中，通过此对象可以获取文件相关信息。

1. 添加依赖

   ```xml
   <dependency>
       <groupId>commons-fileupload</groupId>
       <artifactId>commons-fileupload</artifactId>
       <version>1.3.1</version>
   </dependency>
   ```

2. 在SpringMVC的配置文件中添加配置

   ```xml
   <!--    配置文件上传解析器，将上传的文件封装为MultipartFile对象-->
       <bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver"></bean>
   ```

3. 添加表单

   ```xml
   <form th:action="@{/testUp}" method="post" enctype="multipart/form-data">
       头像:<input type="file" name="photo"><br>
       <input type="submit" value="上传">
   </form>
   ```

4. 创建对应的上传文件的控制器方法

   ```java
       @RequestMapping("/testUp")
       public String testUp(MultipartFile photo,HttpSession session) throws IOException {
           String filename = photo.getOriginalFilename();
           //获取上传的文件的后缀名
           String suffix = filename.substring(filename.lastIndexOf("."));
           //将UUID作为文件名,解决照片重名问题
           String uuid = UUID.randomUUID().toString();
           //将uuid和后缀名拼接后的结果作为最终的文件名
           filename = uuid+suffix;
           ServletContext servletContext = session.getServletContext();
           String photoPath = servletContext.getRealPath("photo");
           System.out.println(photoPath);
           File file = new File(photoPath);
           //判断photoPath所对应路径是否存在
           if(!file.exists()){
               //若不存在，则创建目录
               file.mkdir();
           }
           String finalPath = photoPath+File.separator+filename;//File.separator是分隔符
           photo.transferTo(new File(finalPath));
           return "success";
       }
   ```

