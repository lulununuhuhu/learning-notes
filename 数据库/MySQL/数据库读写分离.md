## 读写分离

### MySQL主从复制

MySQL主从复制是MySQL系统自带的一个功能。它基于底层的**二进制日志**功能，可以将一台或者多台数据库(slave 从库)从一台数据库(master 主库)进行日志的复制，从而将主库的数据变化应用到自身，最终达到从数据库和主数据库一致的效果。

主从复制的过程：

1. 主数据库将数据更改写到binary log中
2. 从数据库使用io线程读取主数据库binary log，将内容拷贝到它的relay log(中继日志)
3. 从数据库读取中继日志，将数据更改应用到自身

![image-20230218111649723](C:/Users/lucheng/AppData/Roaming/Typora/typora-user-images/image-20230218111649723.png)

### 主从库的配置

我在配置主从库的过程中使用的主库是阿里云服务器上的MySQL5.7数据库，从数据库使用的是Windows本地的MySQL8.0数据库。

#### 配置主库

修改主库的配置文件

主库的配置文件我是在宝塔面板的软件管理中打开的，然后进行修改的，算是图方便。

![image-20230218112520921](C:/Users/lucheng/AppData/Roaming/Typora/typora-user-images/image-20230218112520921.png)

```
log-bin = mysql-bin # 启动二进制日志
server-id = 100   # 服务器唯一ID
```

2. 重启mysql服务

   修改配置文件后，需要重启后才能使配置生效

   ```shell
   systemctl restart mysqld
   ```

3. 登录主库后，创建主从复制时从库所需要的用户权限

   ```sql
   GRANT REPLICATION SLAVE ON *.*to 'lucheng'@'%' identified by '13921350895lc'
   ```

   该句SQL的作用时创建一个用户名为lucheng，密码是13921350895lc的用户，并给该用户授予**REPLICATION SLAVE **权限，该权限是建立主从复制关系时，slave必须拥有的权限。

4. 登录MySQL数据库，执行下面SQL，记录下结果中**File和Position的值**

   ```sql
   show master status; -- 查询master库的状态
   ```

   执行完该句sql后不要执行任何操作。

#### 配置从库

1. 修改配置文件，Windows中配置文件是my.ini

   ```
   server-id = 101 # 服务器唯一ID
   ```

2. 重启MySQL服务

   在Windows中我选择使用右键电脑-管理-程序和服务中进行重启

3. 登录MySQL数据库，执行下面的SQL语句

   ```sql
   change master to master_host='master库的ip地址',master_user='主库创建的用户名',master_password='主库创建的密码',master_log_file='主库状态中File的值',master_log_pos=主库状态中Positon的值;
   
   start slave;
   ```

4. 查询从库状态，看是否配置成功

   ```sql
   show slave status;
   ```

   ![image-20230218114248931](C:/Users/lucheng/AppData/Roaming/Typora/typora-user-images/image-20230218114248931.png)

​	如果Slave_IO_State字段的值是这样的话，就说明配置成功。

> 注：如果要重新配置主从关系话，先要将上一个配置的从库进程停止，使用命令
>
> ```sql
> stop slave;
> ```

> 注：在配置好主从关系后，从库就只能作一些读操作，不能进行数据修改，否则会导致主从数据不一致，从而接下来主数据库的数据修改无法正确同步到从数据库中。